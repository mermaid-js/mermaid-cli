FROM node:current-slim AS build

WORKDIR /app

COPY . /app/

RUN yarn \
    && chmod 755 copy_modules.sh \
    && ./copy_modules.sh \
    && yarn prepublishOnly \
    && yarn pack

FROM node:current-slim AS mermaid-cli-current

ENV CHROME_DEVEL_SANDBOX=/usr/local/sbin/chrome-devel-sandbox

COPY --from=build /app/*-mermaid-cli-*.tgz /install/
COPY --from=build /app/puppeteer-config.json /puppeteer-config.json

ADD install-dependencies.sh /install-dependencies.sh
RUN chmod 755 /install-dependencies.sh && /install-dependencies.sh

RUN useradd -ms /bin/bash mermaidcli
USER mermaidcli
WORKDIR /home/mermaidcli
RUN yarn add $(ls -d /install/*.tgz)

USER root
ADD setup-sandbox.sh /setup-sandbox.sh
RUN chmod 755 /setup-sandbox.sh && /setup-sandbox.sh
USER mermaidcli

ENTRYPOINT ["./node_modules/.bin/mmdc"]
CMD [ "--help" ]
